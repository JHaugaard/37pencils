---
/**
 * Figure Component - Optimized Images with Captions
 *
 * How astro:assets works:
 *
 * 1. IMPORT: Images are imported as modules (not URL strings)
 *    import myImage from '../assets/images/photo.jpg';
 *
 * 2. TRANSFORM: At build time, Astro:
 *    - Generates multiple sizes for srcset
 *    - Converts to modern formats (WebP, AVIF)
 *    - Calculates dimensions to prevent layout shift
 *    - Optimizes quality/compression
 *
 * 3. OUTPUT: Produces optimized images in dist/_astro/
 *    - Original: photo.jpg (800KB)
 *    - Optimized: photo_abc123.webp (80KB)
 *
 * src/ vs public/ images:
 *
 * ┌─────────────────────────────────────────────────────────┐
 * │ src/assets/images/                                      │
 * │ • Imported as modules: import img from './photo.jpg'    │
 * │ • Processed at build time                               │
 * │ • Generates WebP, multiple sizes, srcset                │
 * │ • Hash-based filenames for caching                      │
 * │ • Width/height calculated automatically                 │
 * │ • USE FOR: Photos, content images, hero images          │
 * └─────────────────────────────────────────────────────────┘
 *
 * ┌─────────────────────────────────────────────────────────┐
 * │ public/                                                 │
 * │ • Referenced by URL: src="/photo.jpg"                   │
 * │ • Copied as-is, no processing                           │
 * │ • Original format, original size                        │
 * │ • Direct URL access                                     │
 * │ • USE FOR: Favicons, robots.txt, files needing exact URL│
 * └─────────────────────────────────────────────────────────┘
 */

import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
  /** The imported image (use: import myImg from '../assets/images/photo.jpg') */
  src: ImageMetadata;
  /** Alt text for accessibility (required) */
  alt: string;
  /** Optional caption displayed below the image */
  caption?: string;
  /** Optional width constraint (defaults to full width, max 672px) */
  width?: number;
  /** Loading strategy: 'lazy' (default) or 'eager' for above-fold images */
  loading?: 'lazy' | 'eager';
  /** Optional CSS class for the figure element */
  class?: string;
}

const {
  src,
  alt,
  caption,
  width,
  loading = 'lazy',
  class: className,
} = Astro.props;

// Generate responsive widths for srcset
// These cover common viewport/display scenarios
const widths = [400, 600, 800, 1200];

// Default to content width if not specified
const displayWidth = width || 672;
---

<figure class:list={['my-8', className]}>
  <Image
    src={src}
    alt={alt}
    widths={widths}
    sizes={`(max-width: ${displayWidth}px) 100vw, ${displayWidth}px`}
    width={displayWidth}
    loading={loading}
    decoding="async"
    class="w-full h-auto rounded"
    format="webp"
    quality={80}
  />
  {caption && (
    <figcaption class="mt-2 text-sm text-gray-500 text-center italic">
      {caption}
    </figcaption>
  )}
</figure>

<style>
  figure {
    /* Ensure figure doesn't break out of content width */
    max-width: 100%;
  }

  figure :global(img) {
    /* Smooth fade-in for lazy-loaded images */
    transition: opacity 0.3s ease;
  }
</style>
